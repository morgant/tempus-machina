#!/bin/sh -e

#
# tmutil - a macOS (nee OS X) work-alike powered by rsync
#

# info
tool="$(basename "$0")"
version="0.1"
copyright="(c) 2021 Morgan Aldridge"

# global variables
verbose=false
config_path="/etc/${tool}"
config_path=".${config_path}" # TODO: remove this development hack
verb=""

# print usage instructions (help)
usage() {
  echo "Usage: ${tool} <verb> [options]"
  echo
}

version() {
  echo "${tool} v${version} ${copyright}"
}

init_configs() {
  if [ ! -d "${config_path}" ] ; then
    if mkdir -p "${config_path}" ; then
      $verbose && echo "Created config path '${config_path}'"

      touch "${config_path}/destinations"
      $verbose && echo "Created '${config_path}/destinations' config file"
    else
      echo "Error! Unable to create config path '${config_path}'!"
      return 1
    fi
  else
    $verbose && echo "Config path '${config_path}' exists"
  fi
}

is_valid_destination() {
  if [ -z "$1" -o ! -d "$1" ] ; then
    return 1
  fi
}

is_remote_destination() {
  echo "$1" | grep -E ".+:./+" > /dev/null
}

destination_type() {
  is_remote_destination "$1" && echo "Remote" || echo "Local"
}

has_destination() {
  while IFS= read -r line ; do
    if [ "$line" = "$1" ] ; then
      return 0
    fi
  done < "${config_path}/destinations"
  return 1
}

print_destinations() {
  while IFS= read -r line ; do
    echo "===================================================="
    echo "Name          : n/a"
    echo -n "Kind          : "
    destination_type "$1"
    echo "Mount Point   : ${line}"
    echo "ID            : n/a"
  done < "${config_path}/destinations"
}

remove_all_destinations() {
  echo -n "" > "${config_path}/destinations"
  $verbose && echo "Removed all destinations"
}

add_destination() {
  if ! is_valid_destination "$1" ; then
    echo "Error! Could not add '${1}' because it not a valid destination!"
    return 1
  fi

  if has_destination "$1" ; then
    $verbose && echo "Destination '${1}' already added"
  else
    echo "$1" >> "${config_path}/destinations"
    $verbose && echo "Added destination '${1}'"
  fi
}

main() {
  # parse input args
  if [ $# -eq 0 ]; then
    usage
    exit 1
  fi
  while [ $# -gt 0 -a -z "${verb}" ]; do
    case "$1" in
      -h|--help|help)
        usage
        exit
        ;;
      -v)
        verbose=true
        ;;
      -V|--version|version)
        version
        exit
        ;;
      setdestination|destinationinfo)
        verb="$1"
        ;;
      *)
        echo "Unknown verb '${1}'."
        usage
        exit 1
        ;;
    esac
    shift
  done

  if [ -z "${verb}" ] ; then
    usage
    exit 1
  fi

  init_configs

  case "${verb}" in
    setdestination)
      setdestination_append=false
      while getopts a opt_name ; do
        case "${opt_name}" in
          a)
            setdestination_append=true
            ;;
          ?)
            usage
            exit 1
            ;;
        esac
      done
      shift $(( $OPTIND - 1 ))
      if ! $setdestination_append && is_valid_destination "$1" ; then
        remove_all_destinations
      fi
      add_destination "$1"
      ;;
    destinationinfo)
      while getopts X opt_name ; do
        case "${opt_name}" in
          X)
            echo "The '-${opt_name}' option for '${verb}' verb is not supported at this time."
            usage
            exit 1
            ;;
          ?)
            usage
            exit 1
            ;;
        esac
      done
      shift $(( $OPTIND - 1 ))
      print_destinations
      ;;
  esac
}

main "$@"
